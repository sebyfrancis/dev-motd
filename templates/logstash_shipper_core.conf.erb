# Config for a Logstash shipper (i.e. agent)
# Common CentOS logfiles
# configure other logs in the profile class using logstash::configfile

input {
  # Ship common OS log files:
  file {
    type => "os"
    path => [ <% n = @_logs_common.map! { |k| "\"#{k}\""  }.join(",") %> <%= n %> ]
    exclude => ["*.gz", "*.bz2"]
  }
}

filter {
  if [type] == "os" {
    multiline {
      pattern => "^\s"
      what    => "previous"
    }
  
  # Place the real timestamp of the log into in its own field
  # When the bug in the Logstash 'date' filter is fixed, then the 'logtimestamp'
  # field should be converted into the @timestamp field.
  # Bug: https://github.com/elasticsearch/logstash/issues/1700
  
    grok {
      match => [ "message", "%{SYSLOGTIMESTAMP:logtimestamp}" ]
      add_tag => [ "grokdated", "grokked"]
    }
  }
}

output {
  # Note that the 'data_type' and 'key' has to match what's on the Logstash
  # indexer/server's Input config
  redis {
    host      => "<%= @_redis_rr_dns_name %>"
    data_type => "list"
    key       => "<%= @_logstash_redis_key %>"
  }
}
